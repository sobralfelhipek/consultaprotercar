<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Consulta de Ve√≠culos</title>
  <style>
    /* ======= ESTILO GERAL ======= */
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(to bottom, #ffffff 0%, #ff2a2a 35%, #990000 100%);
      color: #ffdd55;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: linear-gradient(to bottom, #ffffff 0%, #ffdddd 100%);
      text-align: center;
      padding: 30px 10px 15px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    header img {
      max-width: 280px;
      height: auto;
    }

    main {
      flex: 1;
      max-width: 900px;
      margin: 30px auto;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(6px);
      padding: 30px;
      border-radius: 14px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
    }

    h1 {
      text-align: center;
      color: #fff;
      margin-bottom: 25px;
      font-size: 1.8rem;
    }

    .search-row {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }

    input#busca {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      box-sizing: border-box;
    }

    button {
      background-color: #ff2a2a;
      color: #fff;
      border: none;
      padding: 12px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.15s ease;
    }

    button:hover { transform: translateY(-2px); }

    #novaBusca {
      display: none;
      background-color: #ffaa00;
      color: #000;
      margin-top: 15px;
      width: auto;
    }

    .alerta {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-weight: 500;
      display: none;
    }

    .alerta-info {
      background-color: rgba(255, 255, 255, 0.15);
      color: #000;
      border: 1px solid rgba(255, 230, 200, 0.7);
    }

    .alerta-critico {
      background-color: rgba(255, 200, 200, 0.15);
      color: #000;
      border: 1px solid rgba(255, 150, 150, 0.7);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      color: #fff;
    }

    th, td {
      padding: 10px;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.12);
      vertical-align: middle;
    }

    td:first-child, th:first-child {
      text-align: left;
      padding-left: 20px;
    }

    th {
      background-color: rgba(255, 0, 0, 0.75);
      color: #fff;
    }

    td {
      background-color: rgba(255, 255, 255, 0.03);
    }

    .share-icon-btn {
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 6px 8px;
    }

    .toggle-franquia-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.12);
      color: #ffd700;
      padding: 6px 8px;
      border-radius: 6px;
      cursor: pointer;
    }

    /* Cards mobile */
    .card {
      display: none;
      background: rgba(0,0,0,0.45);
      padding: 14px;
      border-radius: 12px;
      margin-bottom: 14px;
      color: #fff;
      border: 1px solid rgba(255,255,255,0.06);
    }

    .card .card-title { font-weight: 700; color: #ffd700; margin-bottom: 8px; }
    .card p { margin: 6px 0; }

    .card .btn-row { display:flex; gap:8px; margin-top:10px; align-items:center; }
    .card .btn-row button { padding:8px 10px; border-radius:8px; font-weight:600; }
    .card .btn-whatsapp { background:#25D366; color:#fff; border:none; }
    .card .btn-toggle { background:transparent; border:1px solid rgba(255,255,255,0.08); color:#ffd700; }

    .nenhum-resultado { text-align:center; color:#ffdd55; margin-top:20px; font-style:italic; }

    footer {
      text-align: center;
      color: #ffdd55;
      padding: 20px 10px;
      font-size: 0.9rem;
      background: linear-gradient(to top, rgba(255, 0, 0, 0.2), transparent);
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      margin-top: 30px;
    }

    /* MOBILE RESPONSIVE BEHAVIOR */
    @media (max-width: 768px) {
      table { display: none; }
      .card { display: block; }
      .search-row { flex-direction: column; }
      input#busca { width: 100%; }
      #novaBusca { align-self: flex-end; }
    }
  </style>
</head>

<body>
  <header>
    <img src="PR23.png" alt="Logomarca" />
  </header>

  <main>
    <h1>Consulta de Ve√≠culos</h1>

    <div class="search-row" id="searchContainer">
      <input type="text" id="busca" placeholder="Ve√≠culo Ano (ex: Argo 2010 ou Biz 2018)" />
      <button id="btnBuscar" onclick="buscar()">Buscar</button>
    </div>

    <div style="display:flex; justify-content: flex-end;">
      <button id="novaBusca" onclick="novaBusca()">üîÑ Nova busca</button>
    </div>

    <!-- ALERTAS -->
    <div id="alertaInfo" class="alerta alerta-info">
      ‚ö†Ô∏è <b>Informativo:</b><br>
      N√£o trabalhamos com carro a diesel.
        <br>
        <br>
      Em caso de carro reserva, <b>INFORMAR acr√©scimo de R$20,00</b> na parcela mensal.
    </div>

    <div id="alertaCritico" class="alerta alerta-critico">
      üö´ <b>Observa√ß√£o:</b><br>
      O servi√ßo de rastreamento √© incluso para ve√≠culos com tabela FIPE acima de 30 mil, mediante an√°lise interna e n√£o deve ser cobrado separadamente.
    </div>

    <!-- RESULTADOS -->
    <div id="resultado"></div>
  </main>

  <footer>
    ¬© Desenvolvido por <strong>Felhipe Sobral</strong><br>
    2025 - Todos os direitos reservados ¬©
  </footer>

  <script>
    const url = "https://script.google.com/macros/s/AKfycbxzsQWW99_JoAHoxiRm3uQXcOJ7tk8g1ueij2LUBEM2eXQdmrSf0a2Tp9IfadgH7_4E/exec?busca=";

    function formatarValor(valor) {
      if (valor === null || valor === undefined || valor === "") return "";
      const n = Number(String(valor).replace(/[^\d,-\.]/g, "").replace(",", "."));
      if (isNaN(n)) return valor;
      return n.toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Toggle franquia tanto em desktop (fdesk-INDEX) quanto em mobile (franquia-INDEX)
    function toggleFranquia(index) {
      const elDesk = document.getElementById(`fdesk-${index}`);
      const elCard = document.getElementById(`franquia-${index}`);
      const btnDesk = document.getElementById(`toggle-desk-${index}`);
      const btnCard = document.getElementById(`toggle-card-${index}`);

      const currentlyHidden = (elCard && elCard.dataset && elCard.dataset.visible === "false") || (elDesk && elDesk.dataset && elDesk.dataset.visible === "false");

      if (elDesk) {
        if (currentlyHidden) {
          elDesk.innerText = `R$ ${formatarValor(elDesk.dataset.real)}`;
          elDesk.dataset.visible = "true";
          if (btnDesk) btnDesk.innerText = "Ocultar";
        } else {
          elDesk.innerText = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
          elDesk.dataset.visible = "false";
          if (btnDesk) btnDesk.innerText = "Mostrar";
        }
      }

      if (elCard) {
        if (currentlyHidden) {
          elCard.innerText = `R$ ${formatarValor(elCard.dataset.real)}`;
          elCard.dataset.visible = "true";
          if (btnCard) btnCard.innerText = "üëÅÔ∏è Ocultar";
        } else {
          elCard.innerText = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
          elCard.dataset.visible = "false";
          if (btnCard) btnCard.innerText = "üëÅÔ∏è Mostrar";
        }
      }
    }

function compartilharWhatsApp(item) {
  const tipo = (item.tipo || "").toString().toLowerCase();
  const icone = tipo === "carro" ? "üöó" : tipo === "moto" ? "üèçÔ∏è" : "";

  // Gera data/hora atual
  const agora = new Date();
  const dia = String(agora.getDate()).padStart(2, "0");
  const mes = String(agora.getMonth() + 1).padStart(2, "0");
  const ano = agora.getFullYear();
  const hora = String(agora.getHours()).padStart(2, "0");
  const min = String(agora.getMinutes()).padStart(2, "0");

  const dataHora = `${dia}/${mes}/${ano} - ${hora}:${min}`;

  const msg =
`${icone} ${item.veiculo}
Mensalidade: R$ ${formatarValor(item.mensalidade)}

Marca: ${item.marca}
Tipo: ${item.tipo}

Consulta realizada no dia ${dataHora}`;

  const link = "https://wa.me/?text=" + encodeURIComponent(msg);
  window.open(link, "_blank");
}

    async function buscar() {
      const campoBusca = document.getElementById("busca");
      const termoRaw = campoBusca.value || "";
      const termo = termoRaw.trim().replace(/\s+/g, " ");
      const divResultado = document.getElementById("resultado");
      const alertaInfo = document.getElementById("alertaInfo");
      const alertaCritico = document.getElementById("alertaCritico");
      const novaBuscaBtn = document.getElementById("novaBusca");
      const btnBuscar = document.getElementById("btnBuscar");
      const searchContainer = document.getElementById("searchContainer");

      divResultado.innerHTML = "";
      alertaInfo.style.display = "none";
      alertaCritico.style.display = "none";
      novaBuscaBtn.style.display = "none";

      if (!termo) {
        divResultado.innerHTML = "<p class='nenhum-resultado'>Digite algo para buscar.</p>";
        return;
      }

      // show loader
      divResultado.innerHTML = `<div style="text-align:center; padding:18px;"><div style="display:inline-block; width:36px; height:36px; border-radius:50%; border:4px solid rgba(255,255,255,0.15); border-left-color:#ffd54a; animation:spin 1s linear infinite;"></div><p style="margin-top:8px;">Buscando...</p></div>`;

      try {
        const resposta = await fetch(url + encodeURIComponent(termo));
        const data = await resposta.json();

        if (!data || data.length === 0 || data[0].erro) {
          divResultado.innerHTML = `<p class='nenhum-resultado'>${data && data[0] && data[0].erro ? data[0].erro : 'Nenhum ve√≠culo encontrado.'}</p>`;
          // show nova busca button so user can try again
          novaBuscaBtn.style.display = "block";
          return;
        }

        // show alerts and novaBusca
        alertaInfo.style.display = "block";
        alertaCritico.style.display = "block";
        novaBuscaBtn.style.display = "block";

        // hide search input and buscar button (as requested)
        searchContainer.style.display = "none";

        // build table (desktop)
        let tabela = `
          <table>
            <thead>
              <tr>
                <th>VE√çCULO</th>
                <th>MENSALIDADE (R$)</th>
                <th>FRANQUIA (R$)</th>
                <th>MARCA</th>
                <th>TIPO</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
        `;

        // build cards (mobile)
        let cards = "";

        data.forEach((item, idx) => {
          // ensure safe strings
          const veiculo = item.veiculo || "";
          const mensalidade = item.mensalidade || "";
          const franquia = item.franquia || "";
          const marca = item.marca || "";
          const tipo = item.tipo || "";

          const emoji = (tipo.toString().toLowerCase() === "carro") ? "üöó" : (tipo.toString().toLowerCase() === "moto") ? "üèçÔ∏è" : "";

          // table row with share icon (üü¢) and hidden franquia
          tabela += `
            <tr>
              <td>${emoji} ${veiculo}</td>
              <td>R$ ${formatarValor(mensalidade)}</td>
              <td><span id="fdesk-${idx}" data-real="${franquia}" data-visible="false">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                  <button id="toggle-desk-${idx}" class="toggle-franquia-btn" onclick="toggleFranquia(${idx})">Mostrar</button>
              </td>
              <td>${marca}</td>
              <td>${tipo}</td>
              <td><button class="share-icon-btn" title="Compartilhar" onclick='compartilharWhatsApp(${JSON.stringify(item).replaceAll("'", "\\'")})'>
  <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="#25D366" viewBox="0 0 24 24">
    <path d="M20.52 3.48A11.8 11.8 0 0 0 12 0C5.37 0 0 5.23 0 11.69c0 2.06.54 4.07 1.58 5.85L0 24l6.65-1.73a12.3 12.3 0 0 0 5.35 1.24h.01c6.63 0 12-5.23 12-11.69 0-3.12-1.23-6.06-3.48-8.34ZM12 21.36h-.01c-1.7 0-3.36-.45-4.82-1.3l-.35-.2-3.94 1.03 1.05-3.82-.23-.39a9.85 9.85 0 0 1-1.4-5.2C2.3 6.24 6.68 2 12 2c2.61 0 5.06 1 6.88 2.81A9.5 9.5 0 0 1 22 11.31c0 5.17-4.48 10.05-10 10.05Zm5.44-7.5c-.3-.15-1.77-.87-2.04-.97-.27-.1-.47-.15-.67.15-.2.29-.77.97-.95 1.17-.17.2-.35.22-.65.07-.3-.14-1.25-.46-2.38-1.47a9.2 9.2 0 0 1-1.7-2.12c-.17-.29-.02-.45.13-.6.14-.14.3-.35.44-.52.14-.17.2-.29.3-.49s.05-.37-.02-.52c-.07-.15-.67-1.61-.92-2.21-.24-.58-.49-.51-.67-.52h-.57c-.2 0-.52.07-.79.37-.27.29-1.04 1.02-1.04 2.48 0 1.46 1.07 2.87 1.22 3.07.15.2 2.1 3.3 5.09 4.62.71.31 1.27.49 1.7.63.71.23 1.35.2 1.86.12.57-.08 1.77-.72 2.02-1.42.25-.7.25-1.32.17-1.45-.07-.12-.27-.2-.57-.35Z"/>
  </svg>
</button></td>
            </tr>
          `;

          // mobile card
          cards += `
            <div class="card" id="card-${idx}">
              <div class="card-title">${emoji} ${veiculo}</div>
              <p><strong>Mensalidade:</strong> R$ ${formatarValor(mensalidade)}</p>
              <p><strong>Franquia:</strong> <span id="franquia-${idx}" data-real="${franquia}" data-visible="false">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span></p>
              <p><strong>Marca:</strong> ${marca}</p>
              <p><strong>Tipo:</strong> ${tipo}</p>
              <div class="btn-row">
                <button id="toggle-card-${idx}" class="btn-toggle" onclick="toggleFranquia(${idx})">üëÅÔ∏è Mostrar</button>
                <button class="btn-whatsapp btn-whatsapp-mobile" onclick='compartilharWhatsApp(${JSON.stringify(item).replaceAll("'", "\\'")})'>
  <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="#fff" viewBox="0 0 24 24">
    <path d="M20.52 3.48A11.8 11.8 0 0 0 12 0C5.37 0 0 5.23 0 11.69c0 2.06.54 4.07 1.58 5.85L0 24l6.65-1.73a12.3 12.3 0 0 0 5.35 1.24h.01c6.63 0 12-5.23 12-11.69 0-3.12-1.23-6.06-3.48-8.34Z"/>
  </svg>
</button>
              </div>
            </div>
          `;
        });

        tabela += `</tbody></table>`;

        // render both (CSS will hide table on mobile and show cards)
        divResultado.innerHTML = tabela + cards;

      } catch (erro) {
        console.error(erro);
        divResultado.innerHTML = `<p class='nenhum-resultado'>Erro ao buscar dados. Verifique a conex√£o.</p>`;
        document.getElementById("novaBusca").style.display = "block";
      }
    }

    function novaBusca() {
      const campoBusca = document.getElementById("busca");
      const novaBtn = document.getElementById("novaBusca");
      document.getElementById("resultado").innerHTML = "";
      document.getElementById("alertaInfo").style.display = "none";
      document.getElementById("alertaCritico").style.display = "none";
      // re-show search
      document.getElementById("searchContainer").style.display = "flex";
      novaBtn.style.display = "none";
      campoBusca.value = "";
      campoBusca.focus();
    }

    // small spinner css injection for loader animation
    (function addSpinnerKeyframes(){
      const style = document.createElement('style');
      style.textContent = `@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}`;
      document.head.appendChild(style);
    })();
  </script>
</body>
</html>
